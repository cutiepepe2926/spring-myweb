<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cutiepepe2926.myweb.product.ProductMapper">
    <insert id="prodRegist" parameterType="ProductVO">
        INSERT INTO PRODUCT(
                            PROD_ENDDATE,
                            PROD_CATEGORY,
                            PROD_WRITER,
                            PROD_NAME,
                            PROD_PRICE,
                            PROD_COUNT,
                            PROD_DISCOUNT,
                            PROD_PURCHASE_YN,
                            PROD_CONTENT,
                            PROD_COMMENT)
        VALUES (
                #{prodEnddate},
                #{prodCategory},
                #{prodWriter},
                #{prodName},
                #{prodPrice},
                #{prodCount},
                #{prodDiscount},
                #{prodPurchaseYn},
                #{prodContent},
                #{prodComment}
                )
    </insert>

<!--    파라미터 2개 이상이면 parameterType 생략-->
<!--    동적 쿼리 구문,
        if, choose, foreach가 있음
        if 구문의 test에는 getter명이 들어갈 수 있음.

-->
    <select id="getList" resultType="ProductVO">
        SELECT *
        FROM PRODUCT P

        LEFT JOIN (
        SELECT CONCAT(A1.group_ID, A1.CATEGORY_ID) AS CATEGORY_KEY,
        CASE A1.category_parent_LV WHEN 0 THEN A1.category_detail_NM
        WHEN 1 THEN CONCAT(A2.category_detail_NM,' > ', A1.category_detail_NM)
        WHEN 2 THEN CONCAT(A3.category_detail_NM, ' > ', A2.category_detail_NM,' > ', A1.category_detail_NM)
        END as CATEGORY_NAV
        FROM PRODUCT_CATEGORY A1
        LEFT OUTER JOIN PRODUCT_CATEGORY A2
        ON A1.CATEGORY_PARENT_LV = A2.CATEGORY_LV AND A1.CATEGORY_DETAIL_PARENT_LV = A2.CATEGORY_DETAIL_LV AND A1.GROUP_ID = A2.GROUP_ID
        LEFT OUTER JOIN PRODUCT_CATEGORY A3
        ON A2.CATEGORY_PARENT_LV = A3.CATEGORY_LV AND A2.CATEGORY_DETAIL_PARENT_LV = A3.CATEGORY_DETAIL_LV
        ORDER BY CATEGORY_NAV ASC) X
        ON P.PROD_CATEGORY = X.CATEGORY_KEY

        WHERE PROD_WRITER = #{prodWriter}
        <if test="cri.searchName != '' and cri.searchName != null ">
            AND PROD_NAME LIKE CONCAT('%', #{cri.searchName}, '%')
        </if>
        <if test="cri.searchContent != '' and cri.searchContent != null ">
            AND PROD_CONTENT LIKE CONCAT('%', #{cri.searchContent}, '%')
        </if>
        <if test="cri.startDate != '' and cri.startDate != null ">
            <![CDATA[
                    AND PROD_ENDDATE >= #{cri.startDate}
            ]]>
        </if>
        <if test="cri.endDate != '' and cri.endDate != null ">
            <![CDATA[
                    AND PROD_REGDATE <= #{cri.endDate}
            ]]>
        </if>
        ORDER BY
        <if test="cri.searchPrice == 'asc'">
            PROD_PRICE ASC,
        </if>
        <if test="cri.searchPrice == 'desc'">
            PROD_PRICE DESC,
        </if>
        PROD_ID DESC

        LIMIT #{cri.pageStart}, #{cri.amount}
    </select>

    <select id="getDetail" parameterType="long">
        SELECT *
        FROM PRODUCT P
        LEFT JOIN (
        SELECT
        CONCAT(A1.group_ID, A1.CATEGORY_ID) AS CATEGORY_KEY,
        CASE A1.category_parent_LV
            WHEN 0 THEN A1.category_detail_NM
            WHEN 1 THEN CONCAT(A2.category_detail_NM,' > ', A1.category_detail_NM)
            WHEN 2 THEN CONCAT(A3.category_detail_NM, ' > ', A2.category_detail_NM,' > ', A1.category_detail_NM)
        END AS CATEGORY_NAV
        FROM PRODUCT_CATEGORY A1
        LEFT OUTER JOIN PRODUCT_CATEGORY A2
        ON A1.CATEGORY_PARENT_LV = A2.CATEGORY_LV
        AND A1.CATEGORY_DETAIL_PARENT_LV = A2.CATEGORY_DETAIL_LV
        AND A1.GROUP_ID = A2.GROUP_ID
        LEFT OUTER JOIN PRODUCT_CATEGORY A3
        ON A2.CATEGORY_PARENT_LV = A3.CATEGORY_LV
        AND A2.CATEGORY_DETAIL_PARENT_LV = A3.CATEGORY_DETAIL_LV
        ) X
        ON P.PROD_CATEGORY = X.CATEGORY_KEY
        WHERE PROD_ID = #{prodId}
    </select>

    <update id="prodUpdate" parameterType="ProductVO">
        UPDATE PRODUCT
        SET
            PROD_ENDDATE = #{prodEnddate},
            PROD_NAME = #{prodName},
            PROD_PRICE = #{prodPrice},
            PROD_COUNT = #{prodCount},
            PROD_DISCOUNT = #{prodDiscount},
            PROD_PURCHASE_YN = #{prodPurchaseYn},
            PROD_CONTENT = #{prodContent},
            PROD_COMMENT = #{prodComment}
        WHERE PROD_ID = #{prodId}
    </update>

    <delete id="prodDelete" parameterType="long">
        DELETE
        FROM PRODUCT
        WHERE PROD_ID = #{prodId}
    </delete>

    <select id="getTotal" resultType="int">
        SELECT COUNT(*)
            AS total
        FROM PRODUCT
        WHERE PROD_WRITER = #{prodWriter}
        <if test="cri.searchName != '' and cri.searchName != null ">
            AND PROD_NAME LIKE CONCAT('%', #{cri.searchName}, '%')
        </if>
        <if test="cri.searchContent != '' and cri.searchContent != null ">
            AND PROD_CONTENT LIKE CONCAT('%', #{cri.searchContent}, '%')
        </if>
        <if test="cri.startDate != '' and cri.startDate != null ">
            <![CDATA[
                    AND PROD_ENDDATE >= #{cri.startDate}
            ]]>
        </if>
        <if test="cri.endDate != '' and cri.endDate != null ">
            <![CDATA[
                    AND PROD_REGDATE <= #{cri.endDate}
            ]]>
        </if>
        <if test="cri.searchPrice == 'asc'">
            ORDER BY PROD_PRICE ASC,
        </if>
        <if test="cri.searchPrice == 'desc'">
            ORDER BY PROD_PRICE DESC,
        </if>
    </select>


<!--    // 대분류 조회-->
    <select id="getCategoryList" resultType="CategoryVO">
        SELECT *
        FROM PRODUCT_CATEGORY
        WHERE CATEGORY_LV = 1
    </select>
<!--    중~소분류 카테고리 조회-->
    <select id="getCategoryChildList" resultType="CategoryVO">
        SELECT *
        FROM PRODUCT_CATEGORY
        WHERE GROUP_ID = #{groupId}
          AND CATEGORY_PARENT_LV = #{categoryLv}
          AND CATEGORY_DETAIL_PARENT_LV = #{categoryDetailLv}
    </select>



<!--    join 연습-->
<!--    <select id="manyToOne" resultType="DemoOrderVO">  이렇게 되면 DemoOrder의 DemoMemberVO가 안 받아짐-->
<!--        SELECT *-->
<!--        FROM DEMO_ORDER O-->
<!--        LEFT JOIN DEMO_MEMBER M-->
<!--        ON O.MID = M.MID;-->
<!--    </select>-->

<!--
    id - 연관된 resultMap이름
    type - 반환타입
    property - 멤버변수명
    column - 컬럼명
    association -
-->
    <resultMap id="manyToOneResult" type="DemoOrderVO">
        <result column="oid" property="oId"/>
        <result column="mid" property="mId"/>
        <result column="product_name" property="productName"/>
        <association property="memberVO">
            <result column="mid" property="mId"/>
            <result column="name" property="name"/>
        </association>
    </resultMap>

    <select id="manyToOne" resultMap="manyToOneResult">
        SELECT *
        FROM DEMO_ORDER O
        LEFT JOIN DEMO_MEMBER M
        ON O.MID = M.MID
    </select>

<!--    1:N join-->
    <resultMap id="oneToManyResult" type="DemoMemberVO">
        <id property="mId" column="mid" />
        <result property="name" column="name" />
        <collection property="orderList" ofType="DemoOrderVO">
            <id property="oId" column="oid"/>
            <result property="mId" column="mid" />
            <result property="productName" column="product_name" />
        </collection>
    </resultMap>

    <select id="oneToMany" resultMap="oneToManyResult">
        SELECT *
        FROM DEMO_MEMBER M
        LEFT JOIN DEMO_ORDER O
        ON O.MID = M.MID
        WHERE   O.MID =1
    </select>
</mapper>